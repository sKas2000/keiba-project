# 議論ログ: アーキテクチャ見直し 2026-02-14

## 議論の経緯

スクレイパー v1.4 完成（全オッズ取得成功）を受けて、プロジェクト全体の構成と今後の方向性を議論した。

---

## 決定事項

### 1. 全体方針: UIベース → 全自動パイプラインへ

**旧方針（方向A）:**
scraper → input.json → ev_calculator.jsx（ブラウザUI）で手動操作

**新方針（方向B）:**
scraper → Claude API → Python計算 → 買い目出力を1コマンドで実行

**理由:**
- 評価点の承認フェーズは将来的に廃止する（春日判断）
- Claude APIで評価点取得→Pythonで期待値計算が一本で繋がる
- ev_calculator.jsx v2を作っても、方向Bが実現したら不要になる

**結論: ev_calculator.jsx v2の開発は一旦保留。方向Bのパイプラインを優先。**

---

### 2. 評価点システム: 枠組み維持、中身を進化させる

**評価点（各馬1つの数値）→ ソフトマックス → 期待値 の流れは変えない。**

評価点の算出方法を3段階で進化させる:

#### 第1段階（次に着手）: 定量データの導入

「Claude主観100%」→「データ自動算出の基礎点 + Claude補正」に分離。

| カテゴリ | 現状 | 改善後 |
|---------|------|--------|
| 実力(50) | Claude主観で配点 | 3着内率・着差・コース実績を数式化 → 基礎点を自動算出 → Claudeが±補正 |
| 騎手(20) | 4段階（超一流/A/B/C） | 騎手の年間勝率×100（上限20）で自動算出 |
| 適性(15) | Claude主観 | 同コース・同距離の成績を集計 → 自動算出 |
| 調子(10) | Claude主観 | 馬体重変動・間隔・調教タイムを数式化 |
| 他(5) | Claude主観 | 当面は主観のまま |

**利点:**
- 再現性が上がる（同じデータなら同じ基礎点）
- 検証で「データ部分は正しかったが補正が過大だった」と分析可能
- Claudeの仕事が「0→100点」から「基礎点を見て±補正」に変わる

**必要な追加データ:**
| データ | ソース | 優先度 |
|--------|--------|--------|
| 過去走の着順・着差・上がり3F | netkeiba出馬表 | 高 |
| 騎手の年間勝率・複勝率 | netkeiba騎手ページ | 高 |
| 同コース・同距離の成績 | netkeiba馬の戦績 | 中 |
| 馬体重の推移 | JRA出馬表（取得済み） | — |

#### 第2段階（10レース蓄積後）: レースカテゴリ別の配点ウェイト

固定配点（実力50/騎手20/...）をカテゴリ別に変動させる:
- G1: 実力60 + 騎手10 + 適性15 + 調子10 + 他5
- 未勝利: 実力35 + 騎手25 + 適性20 + 調子15 + 他5
- ハンデ: 実力40 + 騎手15 + 適性15 + 調子10 + 他20

京都4Rの教訓（未勝利戦で1戦馬のテーオーパーセルを過小評価）に対応。

#### 第3段階（30レース以降）: フィードバックループ

検証データから配点ウェイトを回帰分析で逆算。
「騎手を過大評価する傾向」等を定量的に特定して修正。

---

### 3. スクレイパーの整理

- **馬単を削除する**（指示書v3.0のスコープ外、取得しても使わない）
- **3連単は実装しない**（同上）
- 対象券種: 単勝・複勝・馬連・ワイド・3連複の5つ

---

## 保留・見送り事項

### 保留（方針は決めたが着手しない）

| 項目 | 理由 | 着手条件 |
|------|------|---------|
| ev_calculator.jsx v2（JSON読込対応） | 方向Bが実現すれば不要 | パイプラインが頓挫した場合のフォールバック |
| レースカテゴリ別の配点ウェイト | 検証データが足りない | 10レース蓄積後 |
| フィードバックループ（回帰分析） | 検証データが足りない | 30レース以降 |
| 見送り判断の閾値検証 | 検証データが足りない | 10レース蓄積後 |
| レース横断の資金配分ロジック | 優先度低 | パイプライン完成後 |
| 温度パラメータのバックテスト | 検証データが足りない | 10レース蓄積後 |

### 将来構想（議論で出たアイデア）

- **バッチ実行**: 朝に1日のレース日程を取り込み→発走時間前に自動実行
- **netkeiba連携**: 過去走データ・騎手成績の自動取得
- **配点ウェイトの自動最適化**: 蓄積データからの機械学習的アプローチ

---

## 次にやること（優先順）

### P1: 全自動パイプラインの設計

```
jra_scraper.py
    ↓ input.json（オッズ＋馬情報）
netkeiba_scraper.py（新規）
    ↓ 過去走データ・騎手成績を追加
scoring_engine.py（新規）
    ↓ 基礎点を自動算出
Claude API
    ↓ 基礎点を見て±補正 → 最終評価点
ev_calculator.py（新規、Python版）
    ↓ ソフトマックス → 実オッズで期待値算出
出力: 買い目リスト
```

### P2: スクレイパー v1.4.1
- 馬単削除
- コード整理

### P3: Anthropic APIキーの確認
- 春日がAPIキーを持っているか確認
- 料金感覚の把握（1レース分析 ≈ 数十円）

---

## 議論の中で出た重要な認識

1. **評価点の配点は固定であるべきではない** — レースの性質によって「何が重要か」が変わる
2. **Claudeの主観に100%依存するのは再現性が低い** — 同じ馬に日によって違う点をつける
3. **入出力が「各馬1つの数値」である限り、中身はいくらでも差し替えられる** — これが評価点システムの最大の利点
4. **ev_calculator.jsx v2の開発は最優先ではなくなった** — 全自動パイプラインが実現すればUI不要
5. **精度を上げるには「主観を減らす」のではなく「主観と定量を分離する」** — どちらも必要、混ぜるな危険
