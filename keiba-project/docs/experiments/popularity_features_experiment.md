# 人気度・賞金特徴量の実験記録

**実験日**: 2026-02-26
**目的**: 「実力はあるが人気がない馬」を発見し、穴馬を見つける
**結果**: ❌ **不採用**（ROI悪化）

---

## 仮説

**「実力はあるが人気がない馬」= 穴馬**
- 過去成績が良い（z_avg_finish_last5高い、avg_prize_money_last5高い）
- しかし人気が低い（avg_popularity_last5が大きい）
- → この乖離をモデルが学習 → 穴馬を予測

---

## 追加した特徴量

1. **prev_popularity_1**: 前走の人気順位（1=1番人気）
2. **avg_popularity_last5**: 最近5走の平均人気
3. **prev_prize_money_1**: 前走の賞金（万円）
4. **avg_prize_money_last5**: 最近5走の平均賞金

---

## モデル性能への影響

### Binary Model（3着内予測）
- **AUC**: 0.7846 → **0.7863** (+0.0017)
- **Top3的中率**: 48.24% → **48.6%** (+0.36pt)
- **prev_popularity_1**: 重要度6位（5.7%）

### Win Model（1着予測）
- **AUC**: 0.7834 → **0.7958** (+0.0124 ★)
- **prev_popularity_1**: 重要度5位（6.1%）
- **avg_popularity_last5**: 重要度7位（3.7%）

**→ モデル性能は向上（特にWin Model）**

---

## バックテスト結果（2025-01～2026-02、2,776レース）

| 券種 | **人気度あり** | 人気度なし | 差分 | 判定 |
|------|------|------|------|------|
| 単勝 | 80.4% | 78.8% | **+1.6pt** | ✓ 微改善 |
| 複勝 | 83.5% | 83.7% | -0.2pt | → 変化なし |
| **馬連** | **76.1%** | 81.2% | **-5.1pt** | ✗ **悪化** |
| **ワイド** | **78.6%** | 81.9% | **-3.3pt** | ✗ **悪化** |
| 馬単 | 72.7% | 71.4% | +1.3pt | ✓ 微改善 |
| 3連複 | 80.5% | 81.3% | -0.8pt | → 変化なし |
| 3連単 | 72.5% | 68.0% | +4.5pt | ✓ 改善 |

**→ 馬連・ワイドで大幅悪化（-5.1pt, -3.3pt）**

---

## テストデータとの乖離

### テストデータ（10,000行、2025-12～2026-02、362レース）
- 単勝: **159% ★**（+80pt）
- 3連複: **282% ★**（+201pt）
- 3連単: **190% ★**（+122pt）

### フルデータ（346,763行、2019-06～2026-02、2,776レース）
- 単勝: 80.4%（+1.6pt）
- 3連複: 80.5%（-0.8pt）
- 3連単: 72.5%（+4.5pt）

**→ テストデータの好成績は統計的分散によるもの（サンプル数が小さいため偶然）**

---

## なぜ悪化したのか

### 1. **市場追従の罠**（オッズ特徴量と同じ問題）
- 人気度は「市場の予測の集約」
- これを使うと、モデルが市場と同じ予測をする
- 市場と同じ予測 = 期待値ゼロ = ROI向上しない

### 2. **「結果」であり「原因」ではない**
- 人気は実力を反映した**結果**
- 新しい情報を提供していない
- 既に他の特徴量（z_avg_finish_last5など）で実力は表現されている

### 3. **高AUC ≠ 高ROI**
- Win AUC +0.0124と大幅向上
- しかしROIは悪化（馬連-5.1pt、ワイド-3.3pt）
- モデルは「人気馬を当てる」能力が向上したが、それはROIに貢献しない

---

## 教訓

1. **「市場が既に織り込んだ情報」は使わない**
   - オッズ特徴量: ROI悪化（97%→73%）
   - 時間減衰特徴量: ROI悪化（馬連88.9%→75.4%）
   - **人気度特徴量: ROI悪化（馬連81.2%→76.1%）**

2. **高feature importance ≠ 高ROI**
   - prev_popularity_1は重要度6位（5.7%）
   - しかしROIは悪化

3. **テストデータの好成績に惑わされない**
   - サンプル数が小さいと統計的分散が大きい
   - フルデータで検証しないと分からない

---

## 結論

**人気度・賞金特徴量は不採用**

- モデル性能（AUC）は向上するが、実ROIは悪化
- 市場追従の罠に陥る
- 穴馬発見には別のアプローチが必要

---

## 次のアプローチ案

穴馬を見つけるには、**市場が見落としている情報**が必要：

1. **コース適性の深堀り**
   - course_dist_win_rateは重要度低い → より細かい粒度が必要
   - 特定コース×距離×馬場状態での成績

2. **展開予想の精緻化**
   - pace_advantageは重要度低い
   - レース全体のペース予測 × 個体の脚質適性

3. **モデルアンサンブル**
   - binary/win/rankingモデルの重み付け最適化
   - 確率の乖離を利用

4. **フィルタ最適化**
   - 現在: skip_classes=[4,6], conf=0.04, trio=3で複勝83.7%
   - さらなる最適化の余地
