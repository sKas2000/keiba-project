# 統合テストチェックリスト

## 事前準備

### 環境確認
- [ ] Python 3がインストールされている
- [ ] Playwright Chromiumがインストールされている（`playwright install chromium`）
- [ ] インターネット接続が安定している
- [ ] JRA開催日である（土日または祝日）

### ディレクトリ確認
- [ ] `keiba-project/tools/` に全スクリプトが存在する
  - [ ] jra_scraper.py v1.4.1
  - [ ] netkeiba_scraper.py v0.1
  - [ ] scoring_engine.py v0.1
  - [ ] ev_calculator.py v0.1
  - [ ] run_pipeline.bat または run_pipeline.sh

---

## テスト実行手順

### オプション1: 一括実行スクリプト使用（推奨）

```bash
cd tools

# Windows
run_pipeline.bat

# Linux/Mac/Git Bash
bash run_pipeline.sh
```

**実行中の操作:**
1. 開催を選択（例: 1回東京5日）
2. レース番号を入力（例: 11）
3. レース情報を確認してEnter

**所要時間:** 約2〜3分

---

### オプション2: 手動ステップ実行

#### Step 1: JRAオッズ取得
```bash
cd tools
python jra_scraper.py
```

**確認事項:**
- [ ] 開催リストが表示される
- [ ] レース情報（距離・馬場・グレード）が正しく取得される
- [ ] `data/races/YYYYMMDD_会場_レース名_input.json` が生成される
- [ ] 単勝・複勝・馬連・ワイド・3連複のオッズが取得される

**サマリー例:**
```
  出走馬: 16頭
  馬連:   120/120組
  ワイド: 120/120組
  3連複:  560/560組
```

#### Step 2: 過去走・騎手成績追加
```bash
python netkeiba_scraper.py ../data/races/YYYYMMDD_会場_レース名_input.json
```

**確認事項:**
- [ ] 全馬の過去走データが取得される（最大4走）
- [ ] 全騎手の成績が取得される（勝率・連対率）
- [ ] `data/races/YYYYMMDD_会場_レース名_enriched_input.json` が生成される

**出力例:**
```
[1/16] 1番 馬名A
  過去走: 4件取得
  騎手: 騎手名 (勝率15.2%, 連対率38.9%)
```

#### Step 3: 基礎点算出
```bash
python scoring_engine.py ../data/races/YYYYMMDD_会場_レース名_enriched_input.json
```

**確認事項:**
- [ ] 全馬のスコアが計算される（0〜100点）
- [ ] スコア内訳（実力・騎手・適性・調子・その他）が表示される
- [ ] note欄に計算根拠が記録される
- [ ] `data/races/YYYYMMDD_会場_レース名_base_scored.json` が生成される

**出力例:**
```
[スコア一覧]
  [1]  5番 レースホース1      78.0点 (実38.0 騎20.0 適15.0 調4.0 他2.0)
  [2]  8番 レースホース2      72.0点 (実35.0 騎15.0 適12.0 調3.0 他2.0)
```

#### Step 4: 期待値計算・買い目生成
```bash
python ev_calculator.py ../data/races/YYYYMMDD_会場_レース名_base_scored.json
```

**確認事項:**
- [ ] 全券種の期待値が計算される
- [ ] EV 1.0以上の買い目が抽出される
- [ ] S/A/B/Cランクが付与される
- [ ] 確信度が表示される
- [ ] `data/races/YYYYMMDD_会場_レース名_ev_results.json` が生成される

**出力例:**
```
============================================================
  推奨買い目（EV 1.0以上）
============================================================
  [1] 馬連     3-7          EV 1.29 (A級)
  [2] ワイド    3-7          EV 1.15 (B級)
  [3] 複勝     7番           EV 1.08 (B級)
```

---

## データ検証

### input.json の検証
- [ ] `race.name` にレース名が入っている
- [ ] `race.grade` にグレードが入っている（G1/未勝利/etc.）
- [ ] `race.surface` に馬場が入っている（芝/ダート）
- [ ] `race.distance` に距離が入っている（1200〜3600m）
- [ ] `horses` 配列に全出走馬が含まれる
- [ ] `combo_odds.quinella` に馬連オッズが含まれる
- [ ] `combo_odds.wide` にワイドオッズが含まれる
- [ ] `combo_odds.trio` に3連複オッズが含まれる

### enriched_input.json の検証
- [ ] 各馬に `past_races` 配列が追加されている
- [ ] 各馬に `jockey_stats` オブジェクトが追加されている
- [ ] 過去走データに `finish`（着順）が含まれる
- [ ] 過去走データに `margin`（着差）が含まれる
- [ ] 騎手成績に `win_rate`（勝率）が含まれる

### base_scored.json の検証
- [ ] 各馬に `score` が追加されている（0〜100点）
- [ ] 各馬に `score_breakdown` が追加されている
- [ ] 各馬に `note` が追加されている（計算根拠）
- [ ] スコアの合計が妥当である（上位馬が高得点）

### ev_results.json の検証
- [ ] `ev_results.win` に単勝EVが含まれる
- [ ] `ev_results.quinella` に馬連EVが含まれる
- [ ] `ev_results.wide` にワイドEVが含まれる
- [ ] `ev_results.trio` に3連複EVが含まれる
- [ ] `ev_results.confidence` に確信度が含まれる

---

## 結果の妥当性確認

### スコアの妥当性
- [ ] 実績豊富な馬が高評価になっている
- [ ] 超一流騎手（勝率20%前後）が騎手スコア20点満点近くになっている
- [ ] コース実績がある馬が適性スコアで高評価されている
- [ ] 前走が近い馬が調子スコアで高評価されている

### 期待値の妥当性
- [ ] 上位評価馬の単勝EVが0.7〜1.2程度である（過小評価なら1.0以上）
- [ ] 上位2頭の馬連EVが1.0以上である
- [ ] 確信度が妥当である（G1: 60%前後、未勝利: 30%前後）
- [ ] EV 1.0未満の買い目が推奨から除外されている

### オッズとの整合性
- [ ] 単勝1番人気の馬が高スコアになっている
- [ ] 大穴馬（オッズ50倍以上）が低スコアになっている
- [ ] スコア差とオッズ差が概ね対応している

---

## エラーケースの確認

### jra_scraper.py でのエラー
- [ ] 開催が見つからない → JRA開催日を再確認
- [ ] レース情報取得失敗 → JRA公式サイトのHTML構造変更の可能性
- [ ] オッズ組数不足 → 取り消し馬・出走取消を確認

### netkeiba_scraper.py でのエラー
- [ ] 馬が見つからない → 馬名の全角・半角を確認
- [ ] 過去走データ0件 → 新馬戦・HTML構造変更の可能性
- [ ] 騎手が見つからない → 騎手名の表記ゆれを確認

### scoring_engine.py でのエラー
- [ ] スコアが全馬0点 → enriched_input.jsonにデータが含まれているか確認
- [ ] スコア分散が極端に小さい → 温度パラメータを調整

### ev_calculator.py でのエラー
- [ ] combo_oddsエラー → input.jsonにオッズデータが含まれているか確認
- [ ] EV計算結果が異常値 → スコアが正しく計算されているか確認

---

## テスト後の記録

### 記録すべき情報
- [ ] レース名・日付・会場
- [ ] 出走頭数
- [ ] 推奨買い目（EV 1.0以上）
- [ ] 確信度
- [ ] 実際の結果（後日記録）
- [ ] 的中・不的中
- [ ] 回収率

### 記録場所
```
data/races/YYYYMMDD_会場_レース名/
├── input.json
├── enriched_input.json
├── base_scored.json
├── ev_results.json
└── result.txt  ← 実際の結果を記録（手動）
```

**result.txt の例:**
```
レース結果: 2026-02-15 東京11R フェブラリーS

着順:
  1着: 5番 レースホース1
  2着: 8番 レースホース2
  3着: 3番 レースホース3

的中:
  馬連 5-8: 的中 (EV 1.29 → 実際1650円)
  ワイド 5-8: 的中 (EV 1.15 → 実際420円)

回収率:
  投資額: ¥2,000
  払戻額: ¥2,070
  回収率: 103.5%
```

---

## 次回テストへの改善点

### 10レース後の見直し項目
- [ ] 温度パラメータの調整（レースカテゴリ別）
- [ ] スコア配点の見直し（実績 vs 騎手 vs 適性）
- [ ] 見送り基準の調整（確信度・EV閾値）
- [ ] top_nパラメータの調整（対象馬数）

### データ蓄積
- [ ] 10レース分のev_results.jsonを保存
- [ ] 10レース分のresult.txtを記録
- [ ] 的中率・回収率を集計
- [ ] パラメータ最適化を実施

---

## トラブルシューティング

### Playwrightエラー
```bash
# Chromiumが見つからない
playwright install chromium

# ヘッドレスモードで失敗する場合
# jra_scraper.py の headless=True を False に変更
```

### 文字化け
```bash
# Windows環境でUTF-8が正しく表示されない場合
chcp 65001

# またはコマンドプロンプトのプロパティで「レガシコンソールを使う」を無効化
```

### JSON解析エラー
```bash
# JSONが正しく生成されているか確認
cat ../data/races/YYYYMMDD_会場_レース名_input.json | head -50

# 不正なJSON → スクリプトのエラーログを確認
```

---

## テスト完了の確認

全ての項目にチェックが入ったら、統合テスト完了です。

- [ ] 全4ステップが正常に実行された
- [ ] 全データファイルが生成された
- [ ] スコアが妥当である
- [ ] 期待値が妥当である
- [ ] 推奨買い目が提示された
- [ ] エラーケースを確認した
- [ ] 結果を記録する準備ができた

**次のステップ:** 実際のレースで推奨買い目を検証し、結果を記録する。
