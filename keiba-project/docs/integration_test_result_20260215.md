# 統合テスト結果（2026-02-15）

## テスト概要

- 日時: 2026年2月15日
- 対象レース: デイリー杯クイーンカップ（東京11R、OP、芝1600m、16頭立て）
- 実行パイプライン: jra_scraper → netkeiba_scraper → scoring_engine → ev_calculator

---

## 結果サマリー

### ✅ 成功したステップ

#### Step 1: jra_scraper.py v1.4.1
- **ステータス**: 成功
- **実行時間**: 約30秒
- **出力ファイル**: `20260214_東京_デイリー杯クイーンカップ_input.json`
- **取得データ**:
  - レース情報: OP、芝、1600m、左回り
  - 16頭の馬情報（馬番・馬名・騎手・斤量・馬体重）
  - 単勝・複勝オッズ（16頭分）
  - 馬連オッズ（120組）
  - ワイドオッズ（120組）
  - 3連複オッズ（560組）

**評価**: パイプラインStep 1は完全に機能している。

#### Step 3: scoring_engine.py v0.1
- **ステータス**: 成功
- **実行時間**: 数秒
- **入力**: `enriched_input.json`（過去走データなし）
- **出力**: `base_scored.json`
- **結果**: 全馬4.0点（調子2点 + その他2点のみ）
  - 過去走データがないため、実力・騎手・適性スコアは0点
  - パイプライン自体は正常動作

**評価**: データ欠損時のエラーハンドリングが正しく機能している。

#### Step 4: ev_calculator.py v0.1
- **ステータス**: 成功
- **実行時間**: 数秒
- **入力**: `base_scored.json`
- **出力**: `ev_results.json`
- **結果**:
  - 全馬同じスコア（4.0点）のため、確率が均一化（各馬6.2%）
  - 期待値計算は実行されたが、結果は不正確
  - S/A/B/Cランク付けは機能
  - 推奨買い目リスト生成（EV 1.0以上）

**評価**: パイプライン自体は正常動作。実用的な結果を得るには正確なスコアが必要。

---

### ⚠️ 問題が発生したステップ

#### Step 2: netkeiba_scraper.py v0.1
- **ステータス**: 失敗
- **実行時間**: 約1分（エラー頻発のため途中終了）
- **出力**: `enriched_input.json`（生成されたが、データは空）
- **エラー内容**:
  1. `Page.goto: Timeout 15000ms exceeded` (初回実行)
     - `wait_until="networkidle"`がタイムアウト
  2. `Target page, context or browser has been closed` (修正後)
     - ブラウザが途中でクラッシュまたは強制終了された

**問題の詳細**:
- 馬名検索: 検索結果ページ（`search_detail.html`）にリダイレクトされるが、個別の馬ページにアクセスできない
- 騎手検索: ブラウザクラッシュにより全て失敗
- 過去走データ: 0件
- 騎手成績データ: 全て0.0

**推定原因**:
1. netkeibaのHTML構造変更またはセレクター不一致
2. ページロード時間が長く、タイムアウトが発生
3. 連続アクセスによる負荷でブラウザがクラッシュ
4. `headless=False`設定によるメモリ不足の可能性

---

## 生成ファイル

### 成功したファイル

1. `data/races/20260214_東京_デイリー杯クイーンカップ_input.json` ✅
   - サイズ: 約15KB
   - 内容: 完全（オッズ・馬情報すべて含む）

2. `data/races/20260214_東京_デイリー杯クイーンカップ_base_scored.json` ✅
   - サイズ: 約16KB
   - 内容: スコア計算完了（ただし全馬4.0点）

3. `data/races/20260214_東京_デイリー杯クイーンカップ_ev_results.json` ✅
   - サイズ: 約25KB
   - 内容: 期待値計算完了（ただし不正確）

### データ不足のファイル

4. `data/races/20260214_東京_デイリー杯クイーンカップ_enriched_input.json` ⚠️
   - サイズ: 約16KB
   - 内容: 構造は正しいが、`past_races`と`jockey_stats`が全て空

---

## パイプライン検証結果

### ✅ 確認できたこと

1. **データフローの正常性**
   - input.json → enriched_input.json → base_scored.json → ev_results.json
   - 各ステップのファイル入出力が正しく機能

2. **エラーハンドリングの妥当性**
   - データ欠損時でもパイプラインが停止しない
   - scoring_engine: 過去走なし → 実力スコア0点（エラーなし）
   - ev_calculator: スコア同一 → 確率均一化（エラーなし）

3. **出力フォーマットの一貫性**
   - 全JSONファイルが正しいフォーマット
   - UTF-8エンコーディング正常
   - 日本語文字化けなし（Windows環境対策済み）

4. **計算ロジックの動作**
   - ソフトマックス確率変換: 動作確認
   - 期待値計算（全券種）: 動作確認
   - S/A/B/Cランク付け: 動作確認

### ❌ 未確認または失敗した項目

1. **netkeiba_scraperの過去走取得**
   - 馬名検索が正しく機能しない
   - 個別馬ページへのアクセス失敗
   - HTML構造の確認が必要

2. **netkeiba_scraperの騎手成績取得**
   - ブラウザクラッシュにより検証不可
   - リトライメカニズムの実装が必要

3. **実データでのスコア妥当性**
   - 過去走データがないため、スコア計算の妥当性を検証できず

4. **実データでの期待値精度**
   - スコアが不正確なため、期待値の精度を検証できず

---

## 技術的な問題点

### netkeiba_scraper.py の課題

#### 1. タイムアウト設定
- **問題**: `wait_until="networkidle"`が15秒でタイムアウト
- **修正済み**: `wait_until="domcontentloaded"` + `timeout=30000`に変更
- **結果**: タイムアウトは解消されたが、別のエラーが発生

#### 2. ブラウザクラッシュ
- **問題**: `Target page, context or browser has been closed`
- **原因候補**:
  - `headless=False`によるGUI表示でメモリ不足
  - 連続アクセスによる負荷
  - Playwrightのバージョン互換性
- **対策候補**:
  - `headless=True`に変更
  - アクセス間隔を長くする（現在0.5秒 → 2秒）
  - ブラウザを定期的に再起動

#### 3. 検索結果の取得
- **問題**: `search_detail.html`から個別ページにアクセスできない
- **原因候補**:
  - セレクター`table.nk_tb_common a[href*='/horse/']`が機能していない
  - netkeibaのHTML構造が変更された
  - 検索結果が0件（馬名表記ゆれ）
- **対策候補**:
  - `headless=False`で手動確認し、HTML構造を調査
  - セレクターを修正
  - デバッグログを詳細化

#### 4. エラーハンドリング
- **問題**: エラー発生時でも処理を続行するが、ログが冗長
- **改善案**:
  - エラーカウントを記録
  - N回連続失敗で処理中断
  - リトライメカニズムの実装

---

## 次のステップ

### 優先度1: netkeiba_scraper.py のデバッグ

1. **HTML構造の確認**
   ```bash
   # headless=False で実行し、ブラウザを目視確認
   python netkeiba_scraper.py --debug
   ```

2. **セレクターの修正**
   - 実際のHTML構造に合わせてセレクターを更新
   - XPathの使用を検討

3. **安定性の向上**
   - `headless=True`に変更
   - アクセス間隔を2秒に延長
   - ブラウザ再起動ロジックを追加

### 優先度2: テストデータでの完全検証

手動で過去走・騎手データを追加したenriched_input.jsonを作成し、scoring_engine → ev_calculatorの妥当性を検証する。

### 優先度3: ドキュメント更新

- トラブルシューティングガイドにnetkeiba関連のエラーを追加
- integration_test_checklist.mdを更新

---

## 結論

### パイプライン全体の評価

**ステータス**: 部分的成功 ⚠️

- **成功**: jra_scraper (Step 1)、scoring_engine (Step 3)、ev_calculator (Step 4)
- **失敗**: netkeiba_scraper (Step 2)

パイプラインの基本フローは正常に機能しているが、**netkeiba_scraper.pyの修正が必須**。

### 今後の方針

1. netkeiba_scraper.pyを優先的にデバッグ
2. 修正後、再度統合テストを実施
3. 10レース分のデータを蓄積し、スコア配点を検証
4. Claude API連携の実装（オプション）

---

## 備考

- Windows環境での文字化け対策（UTF-8出力）は全ツールで正常動作
- Gitコミット履歴:
  - v1.4.1: 馬単削除、統合テストガイド追加
  - v1.5: 基礎点自動算出パイプライン完成
  - v1.6: ev_calculator.py完成、全自動パイプライン構築完了

作成日: 2026-02-15
