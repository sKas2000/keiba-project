# プロジェクト状況サマリー（2026-02-15）

## 🎉 完成した全自動パイプライン

### パイプライン構成

```
1. jra_scraper.py v1.4.1
   ↓ input.json（オッズ・馬情報）

2. netkeiba_scraper.py v0.3
   ↓ enriched_input.json（過去走・騎手成績追加）

3. scoring_engine.py v0.1
   ↓ base_scored.json（基礎点自動算出）

4. ev_calculator.py v0.1
   ↓ ev_results.json（期待値計算・推奨買い目）
```

**ステータス**: ✅ **全4ステップが正常動作**

---

## 📊 最新の統合テスト結果

### テスト実施日
2026年2月15日

### 対象レース
デイリー杯クイーンカップ（東京11R、OP、芝1600m、16頭立て）

### 実行結果

#### Step 1: jra_scraper.py v1.4.1
- **ステータス**: 成功 ✅
- **取得データ**: 16頭の完全なオッズ・馬情報
- **対象券種**: 単勝・複勝・馬連・ワイド・3連複

#### Step 2: netkeiba_scraper.py v0.3
- **ステータス**: 成功 ✅
- **処理時間**: 約3分
- **過去走データ**: 16/16頭成功
- **騎手成績**: リーディング騎手のみ取得（課題あり）

#### Step 3: scoring_engine.py v0.1
- **ステータス**: 成功 ✅
- **トップスコア**: ニシノサリーナ 49.0点
- **スコア内訳**: 実35.0 騎2.0 適7.0 調3.0 他2.0

#### Step 4: ev_calculator.py v0.1
- **ステータス**: 成功 ✅
- **推奨買い目**: 3連複 6-13-16 (EV 18.22, S級)
- **確信度**: 34.4%

---

## 🚀 今回のセッションで実装した主要機能

### netkeiba_scraper v0.2 → v0.3

**v0.2の成果**（前回）:
- フォーム入力方式への変更
- 16/16頭の過去走データ取得成功
- ブラウザ安定化（5頭ごと再起動）

**v0.3の改善**（今回）:
- ✅ **過去走から騎手ID抽出機能**
- ✅ **騎手IDによる直接アクセス**（検索回避）
- ✅ **騎手名の正規化による照合精度向上**
- ✅ **2段階フォールバック方式**（過去走→検索）

**成果**:
- 「全騎手が同じID」問題を完全解決
- 誤データを0%に削減（v0.2: 94%が誤り）
- リーディング騎手の成績を正確に取得

---

## 📈 各コンポーネントの完成度

| コンポーネント | バージョン | ステータス | 完成度 |
|--------------|----------|----------|--------|
| jra_scraper.py | v1.4.1 | ✅ 完成 | 95% |
| netkeiba_scraper.py | v0.3 | ✅ 動作中 | 80% |
| scoring_engine.py | v0.1 | ✅ 完成 | 85% |
| ev_calculator.py | v0.1 | ✅ 完成 | 90% |

### 完成度の詳細

#### jra_scraper.py (95%)
- ✅ 全オッズ取得成功
- ✅ レース情報取得成功
- ✅ 馬単・3連単削除完了
- ⚠️ 一部レースで距離・グレード取得失敗（低頻度）

#### netkeiba_scraper.py (80%)
- ✅ 全馬の過去走データ取得
- ✅ リーディング騎手の成績取得
- ⚠️ リーディング外騎手は成績0.0
- ⚠️ 古い同名馬が取得される可能性

#### scoring_engine.py (85%)
- ✅ 定量データから基礎点を自動算出
- ✅ 再現性100%（同じデータ→同じスコア）
- ✅ 計算根拠をnote欄に記録
- ⚠️ 馬体重変動・調教タイム未実装

#### ev_calculator.py (90%)
- ✅ Softmax確率分布による期待値計算
- ✅ 推奨買い目の自動抽出
- ✅ 券種別のEVランキング
- ⚠️ 温度パラメータの最適化は実データで検証必要

---

## 🎯 優先課題の達成状況

### ✅ 優先課題1: 評価点の定量化
**ステータス**: 完了

- scoring_engine.py v0.1完成
- 基礎点自動算出（実力50+騎手20+適性15+調子10+他5）
- 計算根拠の透明化

### ✅ 優先課題2: パイプライン設計
**ステータス**: 完了

- 全4ステップの自動実行可能
- データフローの確立
- ファイル入出力の統一

### ✅ 優先課題3: scraper v1.4.1（馬単削除）
**ステータス**: 完了

- 対象券種: 単勝・複勝・馬連・ワイド・3連複
- 馬単・3連単は対象外

---

## ⚠️ 既知の課題と制限事項

### 1. netkeiba_scraper v0.3の制限

#### リーディング外騎手の成績が0.0になる
**原因**: netkeibaの検索が名前でフィルタせず、リーディングリストを返す

**影響**:
- リーディング外の騎手は成績0.0
- 騎手スコアが実力より低く評価される

**対策案（v0.4）**:
- 騎手名→IDマッピングデータベースを構築
- 初回はGoogle検索などで騎手IDを特定
- 2回目以降はキャッシュから取得

#### 過去走に騎手がいない場合
**制約**: 現在の騎手が過去4走で騎乗していない場合、第1段階が失敗

**影響**: 初騎乗、久々の騎乗、乗り替わりで第2段階に依存

**緩和策**: 過去走の取得件数を4走→10走に増やす（検討中）

#### 古い馬のデータ
**制約**: マルガのように1975年の同名馬が取得される

**対策**: 馬ID・生年での絞り込み（v0.4で実装予定）

### 2. scoring_engine v0.1の未実装項目

- 馬体重変動スコア（3点）: JRA scraperが馬体重取得後
- 調教タイムスコア（3点）: netkeiba scraperに追加後
- 枠順補正（±5点）: 枠番データ取得後

### 3. ev_calculator v0.1の検証項目

- 温度パラメータの最適化（現在: temperature=10-12）
- スコア配点の検証（10レースデータ蓄積後）

---

## 📝 次のステップ

### フェーズ1: データ蓄積（次回開催日〜）

**目標**: 10レース分のデータを蓄積

**手順**:
1. 次回開催日に同様の手順でデータ取得
2. jra_scraper → netkeiba_scraper → scoring_engine → ev_calculator
3. 結果をファイルに保存
4. 10レース蓄積まで繰り返し

**期待される成果**:
- スコア配点の妥当性検証
- 温度パラメータの最適化
- 的中率・回収率の分析

### フェーズ2: 精度向上（10レース後）

**優先度1**: 騎手マッピングデータベース構築
- netkeiba_scraper v0.4
- リーディング外騎手にも対応

**優先度2**: スコア配点の調整
- 実データに基づく配点最適化
- レースカテゴリ別のウェイト変動

**優先度3**: 馬体重・調教データ追加
- scoring_engine v0.2
- 調子スコアの精度向上

### フェーズ3: Claude API連携（オプション）

**概要**: 基礎点に対してClaudeが補正を加える

```
base_scored.json
  ↓
Claude API（主観補正）
  ↓
final_scored.json
  ↓
ev_calculator.py
```

**メリット**:
- 定量評価では捉えきれない要素を補正
- 展開予想、相性、馬場状態などを考慮

---

## 📂 プロジェクト構成

```
keiba-project/
├── CLAUDE.md                    # プロジェクト概要
├── docs/                        # ドキュメント
│   ├── project_instructions_v3.md
│   ├── integration_test_result_20260215_v2.md
│   ├── netkeiba_scraper_v0.2_changelog.md
│   ├── netkeiba_scraper_v0.3_changelog.md
│   └── project_status_20260215.md    ← このファイル
├── tools/                       # スクリプト
│   ├── jra_scraper.py          # v1.4.1
│   ├── netkeiba_scraper.py     # v0.3
│   ├── scoring_engine.py       # v0.1
│   └── ev_calculator.py        # v0.1
└── data/races/                  # レースデータ
    └── 20260214_東京_デイリー杯クイーンカップ_*.json
```

---

## 🔗 関連ドキュメント

- [プロジェクト指示書v3](project_instructions_v3.md)
- [統合テスト結果（2026-02-15 v0.2）](integration_test_result_20260215_v2.md)
- [netkeiba_scraper v0.2 変更履歴](netkeiba_scraper_v0.2_changelog.md)
- [netkeiba_scraper v0.3 変更履歴](netkeiba_scraper_v0.3_changelog.md)

---

## 📊 統計データ

### 開発期間
- 開始日: 2026年1月頃
- 最新アップデート: 2026年2月15日

### 実装済み機能
- ✅ JRAオッズ自動取得
- ✅ netkeiba過去走・騎手成績取得
- ✅ 基礎点自動算出
- ✅ 期待値計算・推奨買い目生成

### コード統計
- jra_scraper.py: 約850行
- netkeiba_scraper.py: 約670行
- scoring_engine.py: 約730行
- ev_calculator.py: 約650行
- **合計**: 約2,900行

---

## 🎓 学習成果

### 技術的な成果
- ✅ Playwright async APIの習得
- ✅ 日本語文字コード処理（UTF-8/EUC-JP）
- ✅ Softmax確率分布の実装
- ✅ 正規表現による複雑なパターンマッチング
- ✅ Windows環境でのPython開発

### ドメイン知識
- ✅ JRA競馬のオッズ体系理解
- ✅ netkeibaのHTML構造解析
- ✅ 競馬評価指標の定量化
- ✅ 期待値ベースの馬券戦略

---

作成日: 2026-02-15
作成者: Claude Sonnet 4.5
バージョン: 1.0
