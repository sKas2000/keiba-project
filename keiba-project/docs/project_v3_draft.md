# 🏇 競馬分析プロジェクト指示書 v3.0（ドラフト）

**バージョン**: 3.0-draft
**前版からの主要変更**: ツール導入によるワークフロー再設計、役割分担の明確化
**ステータス**: レビュー待ち（10レースの検証データ蓄積後に正式化）

---

## 1. プロジェクト概要

### 目的
日本競馬のレースを体系的に分析し、期待値に基づいた馬券購入判断を行う。

### スコープ
- 対象: JRA主催レース（重賞中心、条件戦・未勝利戦も対象）
- 期間: 2026年シーズン
- 馬場: 芝・ダート

### 成功指標
| 指標 | 目標 | 測定方法 |
|------|------|---------|
| 評価点上位3頭の3着内率 | 60%以上 | 上位3頭のうち1頭以上が3着内 |
| 期待値プラス馬券の的中率 | 理論値±10% | モデル確率と実績の一致度 |
| 月間回収率 | 85%以上 | 払戻金÷投資額 |
| 見送り判断の適切性 | — | 見送りレースの的中困難度を事後検証 |

---

## 2. 設計原則

### 三者の役割分担

**人間（春日）= 判断と決定**
- レース選定、予算配分の最終決定
- 評価点の確認・修正・承認
- 購入/見送りの最終判断
- 改善方針の決定

**Claude = 分析と評価**
- 馬の実力評価（100点満点）
- ペース予想、展開分析
- コース特性の解説
- 温度パラメータの推奨
- 結果検証と改善提案

**ツール = 計算と最適化**
- 評価点→確率のソフトマックス変換
- 全券種の的中確率・期待値の自動算出
- 予算内での最適配分計算
- 市場確率との乖離分析
- 検証メトリクスの集計

### 根本思想
- **GIGO防止**: 計算がいくら精緻でも入力（評価点）が間違えば無意味。品質ゲートで各フェーズの出力を検証する
- **期待値至上**: 感覚ではなく数学で馬券を買う。ただし数学の入力は人間の判断
- **見送りも戦略**: 期待値が追えないレースは買わない勇気

---

## 3. パイプライン（全7フェーズ）

### Phase 0: レース選定（毎週月曜）

| 項目 | 内容 |
|------|------|
| 実行者 | 人間（主）+ Claude（補助） |
| 入力 | JRAレースカレンダー、月間予算残高 |
| 出力 | 週間レース計画（対象レース＋仮予算） |
| 品質ゲート | グレード別予算上限の確認 |

**予算上限（1レースあたり）:**
- G1: ¥10,000 / G2: ¥5,000 / G3: ¥3,000 / 平場: ¥1,500
- 月間上限: ¥50,000

---

### Phase 1: データ収集・構造化

| 項目 | 内容 |
|------|------|
| 実行者 | 人間（データ提供）+ Claude（パース） |
| 入力 | 出馬表PDF、netkeiba出馬表 |
| 出力 | 全馬の構造化データ |
| 品質ゲート | 頭数・馬名・オッズの欠損チェック |

**データ提供の推奨方法:**
1. JRA出馬表PDFをアップロード（現状の方法）
2. netkeiba出馬表のテキストコピペ（フォーマット策定中）

**Claudeがパースする項目:**
馬番、馬名、性齢、斤量、騎手、単勝オッズ、過去4走成績（着順・タイム・着差・上がり）

---

### Phase 2: 評価点付与

| 項目 | 内容 |
|------|------|
| 実行者 | Claude（評価）+ 人間（承認） |
| 入力 | 構造化データ、コース特性 |
| 出力 | 全馬の評価点（100点満点・内訳付き） |
| 品質ゲート | 人間が評価点を確認し承認 |

**評価基準（100点満点）:**

| カテゴリ | 配点 | 重賞 | 条件戦・未勝利 |
|---------|------|------|-------------|
| 実力 | 50点 | GI実績20 + 前走15 + クラス適性15 | 好走率20 + 着差・内容15 + コース実績15 |
| 騎手 | 20点 | 超一流20 / A級15 / B級10 / C級5 | 同左 |
| 適性 | 15点 | 距離8 + コース7 | 同左 |
| 調子 | 10点 | 馬体重3 + ローテ4 + 調教3 | 同左 |
| その他 | 5点 | 斤量3 + 特記2 | 同左 |

**重賞と条件戦の実力評価の違い:**
重賞ではGI/GII/GIIIの実績をベースに評価する。条件戦・未勝利戦ではGI実績がないため「好走率（掲示板率・3着内率）」「着差の小ささ」「コースでの実績」で代替する。

**枠順補正（±5点以内）:**
- 1枠+2 / 2-3枠+3〜4 / 4-6枠±0 / 7-8枠-3〜4 / 最外-5
- 減額: 超一流騎手→マイナス半減 / 85点以上馬→マイナス半減 / 両方→ゼロ化

**展開補正:**
- コース特性（直線距離）×ペース×脚質で補正
- 直線短い＋ハイペース→先行有利大
- 直線長い＋スロー→差し有利

---

### Phase 3: 確率変換 ⚙️

| 項目 | 内容 |
|------|------|
| 実行者 | ツール（自動）+ Claude（温度推奨） |
| 入力 | 評価点、温度パラメータ |
| 出力 | 全馬の1着確率・3着内確率 |
| 品質ゲート | 市場確率と大幅乖離がないか確認 |

**ソフトマックス変換:**
```
P(馬i勝利) = exp(Score_i / T) / Σ exp(Score_j / T)
```

**温度パラメータ(T)の目安:**
- T = 5-7: 堅いレース（圧倒的本命がいる）
- T = 8-12: 標準
- T = 13-20: 荒れやすいレース（ハンデ戦、多頭数の未勝利戦など）

**品質ゲート:**
モデルの1着確率と市場の暗黙確率（1/単勝オッズ×0.8）を比較。+5%以上の乖離がある馬は💎（過小評価＝妙味あり）、-5%以上は⚠️（過大評価）としてフラグ。

---

### Phase 4: オッズ取得・期待値計算 ⚙️

| 項目 | 内容 |
|------|------|
| 実行者 | ツール（計算）+ 人間（オッズ入力） |
| 入力 | 確率データ、最新オッズ |
| 出力 | 全券種の期待値ランキング |
| 品質ゲート | EV+買い目が3点未満なら見送り検討 |

**対象券種:**
単勝、複勝、馬連、ワイド、3連複

**期待値計算:**
```
期待値 = 賭け金 × オッズ × 的中確率
EV率 = オッズ × 的中確率（1.0以上なら理論上プラス）
```

**期待値ランク:**
- S級（EV率1.5以上）: 重点投資
- A級（EV率1.2-1.5）: 標準投資
- B級（EV率1.0-1.2）: 少額投資
- C級（EV率1.0未満）: 不採用

**【課題】組合せオッズの推定:**
現状は「単勝オッズの積÷定数」で推定しており精度が低い。改善案:
1. 馬連・ワイドの実オッズを手入力
2. 過去データからオッズ推定モデルを構築（将来）

---

### Phase 5: 購入判断・資金配分

| 項目 | 内容 |
|------|------|
| 実行者 | 人間（決定）+ ツール（配分計算） |
| 入力 | EV+買い目リスト、予算、確信度 |
| 出力 | 具体的な買い目（券種・金額） |
| 品質ゲート | 予算超過チェック、確信度閾値 |

**見送り判断基準（暫定、要検証）:**
- 確信度15%未満のレース
- EV+の買い目が3点未満
- 上位馬の評価が僅差（差5点以内が4頭以上）

**資金配分:**
EV率に比例した配分を基本とし、100円単位に丸める。

---

### Phase 6: 結果記録・検証

| 項目 | 内容 |
|------|------|
| 実行者 | Claude（分析）+ ツール（集計） |
| 入力 | 着順結果、払戻金 |
| 出力 | 検証レポート |
| 品質ゲート | 評価点上位3頭が3着内に入ったか |

**検証項目:**
1. 評価点ランキング vs 実際の着順
2. モデル確率 vs 実際の結果
3. 期待値プラス買い目の的中/不的中
4. 温度パラメータの適切性
5. 見送り判断の妥当性（見送ったレースの事後分析）

---

### Phase F: フィードバック・改善（月次）

| 項目 | 内容 |
|------|------|
| 実行者 | 人間（方針）+ Claude（分析） |
| 入力 | 累積検証データ |
| 出力 | 指示書更新、パラメータ調整 |
| 品質ゲート | 10レース以上のデータで判断 |

**改善サイクル:**
- 10レースごとに評価精度を確認
- 温度パラメータの最適値をバックテスト
- 評価基準の偏りを分析（騎手過大評価、実力過小評価等）
- 見送り基準の閾値調整

---

## 4. ツール仕様

### 期待値計算ツール（実装済み）

**機能:**
- 評価点入力（内訳表示、直接編集可）
- ソフトマックス確率変換（温度調整スライダー）
- 市場確率との乖離分析
- 全券種の期待値自動算出（単勝・複勝・馬連・ワイド・3連複）
- EV率によるS/A/B/Cランク付け
- 予算配分の自動計算
- レース確信度の表示

**入力が必要な項目:**
- 各馬の評価点（Claudeが初期値を設定、人間が調整）
- 各馬の単勝・複勝オッズ
- 温度パラメータ
- 予算

**【将来拡張】:**
- 馬連・ワイドの実オッズ入力欄
- 過去レースの検証データ蓄積機能
- 複数レースの横断管理

---

## 5. 禁止事項

1. ❌ 評価点を確認せずにPhase 3以降に進む
2. ❌ 確信度が低いレースを「なんとなく」買う
3. ❌ 予算上限を超える
4. ❌ 1レースの結果で評価基準を大幅変更（10レース単位で判断）
5. ❌ 期待値C級の買い目を「直感」で購入
6. ❌ 枠順だけで評価を20点以上変更
7. ❌ 本命を複数設定

---

## 6. 実装ロードマップ

### 完了
- [x] 確率変換エンジン（ソフトマックス）
- [x] 全券種の的中率自動算出
- [x] 期待値ランキング
- [x] 市場確率との乖離分析
- [x] レース確信度の算出

### 優先度1（次に着手）
- [ ] 組合せオッズの推定精度改善
- [ ] 評価基準の定量化（レースカテゴリ別）

### 優先度2
- [ ] 見送り判断の閾値検証（10レース分のデータ後）
- [ ] レース横断の資金配分ロジック

### 優先度3
- [ ] 検証データの蓄積・可視化
- [ ] 温度パラメータのバックテスト
- [ ] データ入力の効率化

### 優先度4
- [ ] 指示書v3.0の正式化
- [ ] 月次レビュープロセスの確立

---

## 7. v2.0からの変更点

| 項目 | v2.0 | v3.0 |
|------|------|------|
| 確率算出 | 手動パターン15個 | ソフトマックス自動変換 |
| 期待値計算 | 主要数点を手計算 | 全券種を自動算出 |
| 見送り判断 | なし | 確信度＋EV+数で判断 |
| 役割分担 | Claude＝全て | 人間＝判断 / Claude＝分析 / ツール＝計算 |
| Step 3.6 | 着順パターンベース | Phase 4（確率ベース）に統合 |
| ワークフロー | 3ステップ | 7フェーズ（品質ゲート付き） |

---

*このドキュメントは10レースの検証データ蓄積後に正式版として確定する*
